<!DOCTYPE html>
<html>
  <head>
    <title>Google Calendar API Quickstart</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Google Calendar API Quickstart</p>

    <!-- Buttons to initiate auth sequence, sign out, and create a test event -->
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
    <button id="create_event_button" onclick="createTestEvent()" style="visibility:hidden;">Create Test Event</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script type="text/javascript">
      /* exported gapiLoaded */
      /* exported gisLoaded */
      /* exported handleAuthClick */
      /* exported handleSignoutClick */
      /* exported createTestEvent */

      // Set your client ID and API key from the Developer Console
      const CLIENT_ID = '999021691122-9cgnoel0l7rnpe81mg1armk9smj9j5eo.apps.googleusercontent.com';
      const API_KEY = '';

      // Discovery doc URL for APIs used by the quickstart
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

      // Use a scope that allows event creation
      const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';
      document.getElementById('create_event_button').style.visibility = 'hidden';

      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      /**
       * Callback after the API client is loaded. Loads the discovery doc to initialize the API.
       */
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      /**
       * Callback after Google Identity Services are loaded.
       */
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      /**
       * Enables user interaction after all libraries are loaded.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      /**
       * Sign in the user upon button click.
       */
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw resp;
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
          // Show the Create Event button after successful authentication
          document.getElementById('create_event_button').style.visibility = 'visible';
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      /**
       * Sign out the user upon button click.
       */
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content').innerText = '';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
          document.getElementById('create_event_button').style.visibility = 'hidden';
        }
      }

      /**
       * Helper function to calculate next Wednesday from a given date.
       */
      function getNextWednesday(date) {
        let result = new Date(date);
        // Wednesday is day 3 (0 = Sunday, 1 = Monday, etc.)
        let day = result.getDay();
        let daysUntilWednesday = (3 - day + 7) % 7;
        if (daysUntilWednesday === 0) {
          daysUntilWednesday = 7; // if today is Wednesday, set to next week
        }
        result.setDate(result.getDate() + daysUntilWednesday);
        return result;
      }

      /**
       * Creates a test event on the authenticated calendar (sbuwyd@gmail.com) and invites ruthvick2005@gmail.com.
       * The event is scheduled for next Wednesday from 3:00 PM to 4:00 PM.
       */
      async function createTestEvent() {
        let now = new Date();
        let nextWednesday = getNextWednesday(now);

        // Set start time: next Wednesday at 3:00 PM
        nextWednesday.setHours(15, 0, 0);
        let startDateTime = nextWednesday.toISOString();

        // Set end time: one hour later (4:00 PM)
        let endTime = new Date(nextWednesday.getTime() + 60 * 60 * 1000);
        let endDateTime = endTime.toISOString();

        // Construct the event object
        let event = {
          summary: 'Test Event: Invitation for Ruthvick',
          description: 'This is a test event to invite ruthvick2005@gmail.com.',
          start: {
            dateTime: startDateTime,
            timeZone: 'America/Los_Angeles' // Adjust to your desired timezone
          },
          end: {
            dateTime: endDateTime,
            timeZone: 'America/Los_Angeles'
          },
          attendees: [
            { email: 'ruthvick2005@gmail.com' }
          ]
        };

        try {
          let request = await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event,
            sendUpdates: 'all' // This sends email notifications to attendees
          });
          console.log('Event created: ', request.result.htmlLink);
          document.getElementById('content').innerText = 'Event created successfully! Check your calendar.';
        } catch (err) {
          console.error('Error creating event: ', err);
          document.getElementById('content').innerText = 'Error creating event: ' + err.message;
        }
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
